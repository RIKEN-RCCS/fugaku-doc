

<!doctype html>

<html lang="ja" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>5.10. ラージページ領域割当て &#8212; 利用手引書 利用およびジョブ実行編  ドキュメント</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="../_static/bizstyle.css?v=532c1bf3" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=89e52957" />
    
    <script src="../_static/documentation_options.js?v=c033477b"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/translations.js?v=4dbe4bdc"></script>
    <script src="../_static/bizstyle.js"></script>
    <link rel="search" title="検索" href="../search.html" />
    <link rel="next" title="5.11. CPUコアとメモリのバインド" href="CPUcoreMemoryBinding.html" />
    <link rel="prev" title="5.9. ジョブ実行コマンドのオプション" href="pjsubCommandOptions.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="CPUcoreMemoryBinding.html" title="5.11. CPUコアとメモリのバインド"
             accesskey="N">次へ</a></li>
        <li class="right" >
          <a href="pjsubCommandOptions.html" title="5.9. ジョブ実行コマンドのオプション"
             accesskey="P">前へ</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">利用手引書 利用およびジョブ実行編  ドキュメント</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U"><span class="section-number">5. </span>ジョブ実行</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">5.10. </span>ラージページ領域割当て</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="id1">
<h1><span class="section-number">5.10. </span>ラージページ領域割当て<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h1>
<p>「富岳」のHPC拡張機能が提供するラージページライブラリについて説明します。</p>
<div class="line-block">
<div class="line">詳細は<a class="reference external" href="https://www.fugaku.r-ccs.riken.jp/docs/manuals_r01#JOS">マニュアル</a>「ジョブ運用ソフトウェア - エンドユーザー向けガイド HPC拡張機能編」を参照してください。</div>
<div class="line">また、「<a class="reference external" href="https://www.fugaku.r-ccs.riken.jp/docs/guides_r01#programing-guide">プログラミングガイド</a>(プログラミング共通編) 」の「ラージページ」の章も参照してください。</div>
</div>
<section id="id4">
<h2><span class="section-number">5.10.1. </span>概要<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h2>
<p>ラージページ機能は、Linuxの標準機能である HugeTLBfs を拡張し、大規模なデータを扱うアプリケーションプログラムに対して、通常のページ（ノーマルページ）より大きなページサイズのメモリ（ラージページ）を割り当てることで、OSのアドレス変換処理によるコストを低減し、メモリアクセス性能を向上させる機能です。</p>
<p>富岳の計算ノードでは、ページサイズとしてノーマルページで64KiB、ラージページで2MiBを利用可能です。デフォルトでラージページ化が有効となっており、環境変数「XOS_MMM_L_HPAGE_TYPE」によってラージページの有効化／無効化を選択できます。</p>
<p>ページサイズの違いによるメリット／デメリットを以下に示します。</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33.3%" />
<col style="width: 33.3%" />
<col style="width: 33.3%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>評価項目</p></th>
<th class="head"><p>64KiB</p></th>
<th class="head"><p>2MiB</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>TLBミス率</p></td>
<td><p>高い</p></td>
<td><p>低い</p></td>
</tr>
<tr class="row-odd"><td><p>メモリ初期化コスト</p></td>
<td><p>小さい</p></td>
<td><p>大きい</p></td>
</tr>
<tr class="row-even"><td><p>メモリ使用効率</p></td>
<td><p>高い</p></td>
<td><p>低い</p></td>
</tr>
</tbody>
</table>
<p>ページング方式には、デマンドページング方式とプリページング方式の2種類があります。</p>
<ul class="simple">
<li><p>デマンドページング方式とは、アプリケーションプログラム実行中に必要なページが主記憶に存在しない場合に、必要に応じてページを主記憶に割り当てる方式のことです。
最初にメモリ領域にアクセスしたタイミングで物理ページを割り当てます。</p></li>
<li><p>プリページング方式とは、あらかじめ主記憶にページを割り当てておく方式のことです。
メモリ領域を割り当てたタイミングで物理ページを割り当てます。</p></li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 33.3%" />
<col style="width: 33.3%" />
<col style="width: 33.3%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>ページング方式</p></th>
<th class="head"><p>NUMA内／外のメモリアクセス</p></th>
<th class="head"><p>初回メモリアクセス</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>デマンドページング方式</p></td>
<td><div class="line-block">
<div class="line">できる限りNUMA内のメモリを使用</div>
<div class="line">（コスト：低い）</div>
</div>
</td>
<td><div class="line-block">
<div class="line">メモリアクセス時にページを物理メモリにロード</div>
<div class="line">（コスト：高い）</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>プリページング方式</p></td>
<td><div class="line-block">
<div class="line">NUMA内外のメモリに関係なく使用</div>
<div class="line">（コスト：高い）</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ページをあらかじめ物理メモリにロード</div>
<div class="line">（コスト：低い）</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>スレッド並列で複数CMGをまたぐときはデマンドページング方式を推奨します。
「<a class="reference external" href="https://www.fugaku.r-ccs.riken.jp/docs/guides_r01#programing-guide">プログラミングガイド</a>(プログラミング共通編) 」の「ラージページのページングポリシー」を参照ください。</p>
</div>
<p>メモリ領域とラージページ化対象を以下に示します。</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50.0%" />
<col style="width: 50.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>領域</p></th>
<th class="head"><p>ラージページ化対象</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>テキスト（.text）領域</p></td>
<td><p>×（64KiBページ）</p></td>
</tr>
<tr class="row-odd"><td><p>静的データ（.data）領域</p></td>
<td><p>○（2MiBページ）</p></td>
</tr>
<tr class="row-even"><td><p>静的データ（.bss）領域</p></td>
<td><p>○（2MiBページ）</p></td>
</tr>
<tr class="row-odd"><td><p>動的メモリ確保領域（ヒープ領域）</p></td>
<td><p>×（64KiBページ）</p></td>
</tr>
<tr class="row-even"><td><p>スレッドヒープ領域</p></td>
<td><p>○（2MiBページ）</p></td>
</tr>
<tr class="row-odd"><td><p>スタック領域</p></td>
<td><p>○（2MiBページ）</p></td>
</tr>
<tr class="row-even"><td><p>スレッドスタック領域</p></td>
<td><p>○（2MiBページ）</p></td>
</tr>
<tr class="row-odd"><td><p>動的メモリ確保領域（mmap領域）</p></td>
<td><p>○（2MiBページ）</p></td>
</tr>
<tr class="row-even"><td><p>共有メモリ</p></td>
<td><p>×（64KiBページ）</p></td>
</tr>
</tbody>
</table>
</section>
<section id="largepageenvironmentvariable">
<span id="id6"></span><h2><span class="section-number">5.10.2. </span>ラージページライブラリ設定用環境変数<a class="headerlink" href="#largepageenvironmentvariable" title="Link to this heading">¶</a></h2>
<p>ラージページライブラリの動作を調整するために、環境変数を利用できます。</p>
<p>ラージページの基本的な設定をするための環境変数を以下に示します。</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33.3%" />
<col style="width: 33.3%" />
<col style="width: 33.3%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>変数名</p></th>
<th class="head"><p>指定値</p></th>
<th class="head"><p>デフォルト値</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>XOS_MMM_L_HPAGE_TYPE</p></td>
<td><p>hugetlbfs|none</p></td>
<td><p>hugetlbfs</p></td>
</tr>
<tr class="row-odd"><td><p>XOS_MMM_L_LPG_MODE</p></td>
<td><p>base+stack|base</p></td>
<td><p>base+stack</p></td>
</tr>
<tr class="row-even"><td><p>XOS_MMM_L_PRINT_ENV</p></td>
<td><p>on|off|1|0</p></td>
<td><p>0</p></td>
</tr>
</tbody>
</table>
<p>環境変数「XOS_MMM_L_PAGING_POLICY」によって、静的データ（.bss領域）、スタック／スレッドスタック領域、および、動的メモリ確保領域にページング方式を設定できます。</p>
<p>ページング方式を設定するための環境変数を以下に示します。</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 60.0%" />
<col style="width: 20.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>変数名</p></th>
<th class="head"><p>指定値</p></th>
<th class="head"><p>デフォルト値</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>XOS_MMM_L_PAGING_POLICY</p></td>
<td><p>[demand|prepage]:[demand|prepage]:[demand|prepage]</p></td>
<td><p>demand:demand:prepage</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>XOS_MMM_L_PAGING_POLICYのデフォルト値をカスタマイズしています。
マニュアル「ジョブ運用ソフトウェア　エンドユーザ向けガイド　HPC拡張機能編」に表記されているデフォルト値 &quot;prepage:demand:prepage&quot; と異なります。</p>
</div>
<p>ラージページ割り当てに関するチューニングするための環境変数を以下に示します。</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33.3%" />
<col style="width: 33.3%" />
<col style="width: 33.3%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>変数名</p></th>
<th class="head"><p>指定値</p></th>
<th class="head"><p>デフォルト値</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>XOS_MMM_L_ARENA_FREE</p></td>
<td><p>1|2</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>XOS_MMM_L_ARENA_LOCK_TYPE</p></td>
<td><p>0|1</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>XOS_MMM_L_MAX_ARENA_NUM</p></td>
<td><p>1 以上 INT_MAX以下の整数値[10進数]</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>XOS_MMM_L_HEAP_SIZE_MB</p></td>
<td><p>MALLOC_MMAP_THRESHOLD_の2倍以上 ULONG_MAX以下の整数値&lt;MiB単位&gt;[10進数]</p></td>
<td><p>MALLOC_MMAP_THRESHOLD_の2倍</p></td>
</tr>
<tr class="row-even"><td><p>XOS_MMM_L_COLORING</p></td>
<td><p>0|1</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>XOS_MMM_L_FORCE_MMAP_THRESHOLD</p></td>
<td><p>0|1</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-even"><td><p>MALLOC_CHECK_</p></td>
<td><p>0|1|2|3|5|7 [10進数]</p></td>
<td><p>3</p></td>
</tr>
<tr class="row-odd"><td><p>MALLOC_TOP_PAD_</p></td>
<td><p>0 以上 ULONG_MAX以下の整数値&lt;byte単位&gt; [10進数]</p></td>
<td><p>131072(=128KiB)</p></td>
</tr>
<tr class="row-even"><td><p>MALLOC_PERTURB_</p></td>
<td><p>INT_MIN 以上 INT_MAX以下の整数値 [10進数]</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p>MALLOC_MMAP_MAX_</p></td>
<td><p>INT_MIN 以上 INT_MAX以下の整数値 [10進数]</p></td>
<td><p>2097152(=2*1024*1024)</p></td>
</tr>
<tr class="row-even"><td><p>MALLOC_MMAP_THRESHOLD_</p></td>
<td><p>0 以上 ULONG_MAX以下の整数値&lt;byte単位&gt; [10進数または16進数]</p></td>
<td><p>134217728(=128MiB)</p></td>
</tr>
<tr class="row-odd"><td><p>MALLOC_TRIM_THRESHOLD_</p></td>
<td><p>0 以上 ULONG_MAX以下の整数値&lt;byte単位&gt; [10進数または16進数]</p></td>
<td><p>134217728(=128MiB)</p></td>
</tr>
</tbody>
</table>
</section>
<section id="linklargepagelibrary">
<span id="id7"></span><h2><span class="section-number">5.10.3. </span>ラージページライブラリのリンク<a class="headerlink" href="#linklargepagelibrary" title="Link to this heading">¶</a></h2>
<p>利用者プログラムからラージページを利用するには、実行可能ファイルにラージページライブラリをリンクする必要があります。</p>
<p>富士通コンパイラを利用する場合は、デフォルトでラージページライブラリをリンクします（<code class="docutils literal notranslate"><span class="pre">-Klargepage</span></code>オプションがデフォルト時有効）。
富士通コンパイラ以外を利用する場合は、ラージページライブラリ「<strong class="program">libmpg.so</strong>」をリンクすることでラージページ化した実行可能ファイルを作成できます。</p>
<p>ラージページライブラリのパスは次の通りです。</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 30.0%" />
<col style="width: 70.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>ノード種別</p></th>
<th class="head"><p>パス名</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ログインノード</p></td>
<td><p>/opt/FJSVxos/devkit/aarch64/rfs/opt/FJSVxos/mmm/lib64</p></td>
</tr>
<tr class="row-odd"><td><p>計算ノード</p></td>
<td><p>/opt/FJSVxos/mmm/lib64</p></td>
</tr>
</tbody>
</table>
<p>ラージページ化するにあたり、本ラージページライブラリは、以下のパスでラージページ用のリンカスクリプトも提供しています。これは、静的データ（.data）、および、静的データ（.bss）をラージページ化するためのものです。このリンカスクリプトもコンパイラに適切に指定してください。</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 30.0%" />
<col style="width: 70.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>ノード種別</p></th>
<th class="head"><p>パス名</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ログインノード</p></td>
<td><p>/opt/FJSVxos/devkit/aarch64/rfs/opt/FJSVxos/mmm/util/bss-2mb.lds</p></td>
</tr>
<tr class="row-odd"><td><p>計算ノード</p></td>
<td><p>/opt/FJSVxos/mmm/util/bss-2mb.lds</p></td>
</tr>
</tbody>
</table>
<p>計算ノードの gcc でコンパイルする場合の例を示します。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gcc<span class="w"> </span>-Wl,-T/opt/FJSVxos/mmm/util/bss-2mb.lds<span class="w"> </span>-L/opt/FJSVxos/mmm/lib64<span class="w"> </span>-lmpg<span class="w"> </span>sample.c
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参考</p>
<p>アプリケーションプログラムが、PIE（Position Independent Executable、位置独立実行形式）でコンパイルされている場合、.data/.bss 領域はラージページ化されません。この場合、ラージページライブラリは警告ログを出力するだけで、.data/.bss 領域にはノーマルページが使用され、アプリケーションプログラムは実行を継続します。</p>
<p>例えば、gcc で明示的にPIE形式とならないようにコンパイルするには、<code class="docutils literal notranslate"><span class="pre">-no-pie</span></code> オプションを使用してください。</p>
</div>
</section>
<section id="id8">
<h2><span class="section-number">5.10.4. </span>メモリ断片化の影響緩和<a class="headerlink" href="#id8" title="Link to this heading">¶</a></h2>
<div class="line-block">
<div class="line">計算ノードで動作しているLinux OSにおいて、メモリ断片化が進行すると、ジョブで使用可能なメモリ量が減少します(これはLinux OSの仕様です)。</div>
<div class="line">このメモリ断片化の影響を緩和する方法として、ラージページに関する環境変数を設定する方法があります。</div>
<div class="line">ただし、いずれの方法も性能低下を招き、ジョブの実行時間が延びる可能性があります。</div>
</div>
<ul>
<li><div class="line-block">
<div class="line">XOS_MMM_L_HPAGE_TYPE=none</div>
<div class="line">ラージページを使用せず、ノーマルページを使用します。</div>
<div class="line">メモリ断片化は「連続した空きメモリ領域」が分断され小さな空き領域が飛び飛びに発生します。このため、大きな連続領域（2MiB以上のページサイズ）を必要とするラージページは影響を受けやすくなります。</div>
<div class="line">ノーマルページを使用することで、より小さな連続領域（64KiBのページサイズ）も使用可能になるため、メモリ断片化の影響を緩和できます。</div>
<div class="line">デメリットとしては、TLBミス率が高くなることで、メモリアクセス性能が低下する可能性があります。</div>
</div>
</li>
<li><div class="line-block">
<div class="line">XOS_MMM_L_HUGETLB_FALLBACK=1</div>
<div class="line">ラージページが不足した場合に、不足分のメモリについてノーマルページによる割り当てを試みます。</div>
<div class="line">ノーマルページでも必要なメモリを確保できない場合は、メモリ枯渇によりプロセスが終了します。</div>
<div class="line">これは、ラージページ使用時のメモリ不足に対する救済措置となります。</div>
<div class="line">この環境変数は、以下の条件を全て満たす場合にのみ有効となり、条件を満たさない場合はデフォルト値の0(無効)が指定されたものとして動作します。</div>
</div>
<ul class="simple">
<li><p>XOS_MMM_L_HPAGE_TYPE=hugetlbfs</p></li>
<li><p>XOS_MMM_L_PAGING_POLICY=*:*:prepage</p></li>
<li><p>XOS_MMM_L_ARENA_LOCK_TYPE=1</p></li>
<li><p>XOS_MMM_L_MAX_ARENA_NUM=1</p></li>
</ul>
<p>デメリットとしては、ノーマルページ割り当ての要否を判断するオーバーヘッドが生じるため、メモリ獲得性能が低下します。</p>
</li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">目次</a></h3>
    <ul>
<li><a class="reference internal" href="#">5.10. ラージページ領域割当て</a><ul>
<li><a class="reference internal" href="#id4">5.10.1. 概要</a></li>
<li><a class="reference internal" href="#largepageenvironmentvariable">5.10.2. ラージページライブラリ設定用環境変数</a></li>
<li><a class="reference internal" href="#linklargepagelibrary">5.10.3. ラージページライブラリのリンク</a></li>
<li><a class="reference internal" href="#id8">5.10.4. メモリ断片化の影響緩和</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>前のトピックへ</h4>
    <p class="topless"><a href="pjsubCommandOptions.html"
                          title="前の章へ"><span class="section-number">5.9. </span>ジョブ実行コマンドのオプション</a></p>
  </div>
  <div>
    <h4>次のトピックへ</h4>
    <p class="topless"><a href="CPUcoreMemoryBinding.html"
                          title="次の章へ"><span class="section-number">5.11. </span>CPUコアとメモリのバインド</a></p>
  </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="検索" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="CPUcoreMemoryBinding.html" title="5.11. CPUコアとメモリのバインド"
             >次へ</a></li>
        <li class="right" >
          <a href="pjsubCommandOptions.html" title="5.9. ジョブ実行コマンドのオプション"
             >前へ</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">利用手引書 利用およびジョブ実行編  ドキュメント</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" ><span class="section-number">5. </span>ジョブ実行</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">5.10. </span>ラージページ領域割当て</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2025, 理化学研究所計算科学研究センター.
    &nbsp;&nbsp;<a href="https://www.fugaku.r-ccs.riken.jp/">Fugaku website Top</a>
    </div>
  </body>
</html>