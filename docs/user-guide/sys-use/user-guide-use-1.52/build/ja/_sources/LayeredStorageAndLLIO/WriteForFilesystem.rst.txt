.. _WriteForFilesystem:

FEFS/LLIOへのファイル操作について
========================================

・書込み操作

  FEFS/LLIOへのファイル書込み方法について、LLIOはFEFSのアクセス方法とは異なる部分があります。
  そのため、1ファイルに対して書込むプロセス数や、IO方法に分けて説明します。

  +----------------------------------+------------------------------+------------------------------+---------------------------------------------------------+---------------------------------------------------------+
  |                                  |ファイル書込みプロセス数      |1プロセス                     |複数プロセス                                                                                                       |
  +                                  +------------------------------+------------------------------+---------------------------------------------------------+---------------------------------------------------------+
  |領域名                            |IO方法                        |MPI-IO使用しない              |MPI-IO使用                                               |MPI-IO使用しない                                         |
  +==================================+==============================+==============================+=========================================================+=========================================================+
  |ノード内テンポラリ領域                                           | :ref:`WriteOneProc`          | :ref:`WriteMultiProcMPI` (\*)                           | :ref:`WriteMultiProcSys` (\*)                           |
  +----------------------------------+------------------------------+------------------------------+---------------------------------------------------------+---------------------------------------------------------+
  |共有テンポラリ領域                                               | :ref:`WriteOneProc`          | :ref:`WriteMultiProcMPI`                                | :ref:`WriteMultiProcSys`                                |
  +----------------------------------+------------------------------+------------------------------+---------------------------------------------------------+---------------------------------------------------------+
  |第2階層ストレージのキャッシュ領域                                | :ref:`WriteOneProc`          | :ref:`WriteMultiProcMPI`                                | :ref:`WriteMultiProcSys`                                |
  +----------------------------------+------------------------------+------------------------------+---------------------------------------------------------+---------------------------------------------------------+
  |第2階層ストレージ                                                | :ref:`WriteOneProc`          | :ref:`WriteMultiProcMPI`                                | :ref:`WriteMultiProcSys`                                |
  +----------------------------------+------------------------------+------------------------------+---------------------------------------------------------+---------------------------------------------------------+

  (\* : ノード内に閉じた場合のみ使用可能)

・ファイル名変更操作

  ファイル名変更操作については、:ref:`renameexec` で説明しています。

・ファイル削除操作

  ファイル削除操作については、:ref:`unlinkexec` で説明しています。

.. _WriteOneProc:

１ファイルに対して１プロセスから書込む場合
-------------------------------------------

1ファイルに対して1プロセスから書込みを行う場合は、FEFS/LLIOともに、write処理を実施します。

.. figure:: img/WriteFileSingleProcess_01.png

[１ファイルに対して１プロセスから 1 MB のデータを書込むコード例]

  .. code-block:: c
    :linenos:

    int fd;
    fd = open("output.txt", O_WRONLY | O_CREAT, 0644);
    write(fd, data, 1000000);
    close(fd);

  .. Attention::

    コード例では省略していますが、open処理やwrite処理などのエラー対処は必ず行うようにしてください。

１ファイルに対して複数プロセスから書込む場合
----------------------------------------------

1ファイルに対して、複数プロセスから書込みを行う場合について、MPI-IOを用いた場合とwriteシステムコールを用いた場合で説明します。

.. figure:: img/WriteFileMultiProcess_01.png

.. _WriteMultiProcMPI:

MPI-IOを使用したファイル書込み方法
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

FEFS/LLIOともに、１ファイルに対して複数プロセスから書込む場合、MPI-IOを利活用できます。

[新規で作成した１ファイルに対して複数プロセスから 1 MB ずつデータを書込むコード例]

  .. code-block:: c
    :linenos:

    MPI_File fh;
    MPI_File_open(MPI_COMM_WORLD, "output.txt", MPI_MODE_CREATE | MPI_MODE_WRONLY, MPI_INFO_NULL, &fh);
    MPI_Offset offset = RANK*1000000;
    MPI_File_write_at(fh, offset, data, 1000000, MPI_CHAR, MPI_STATUS_IGNORE);
    MPI_File_close(&fh);

  .. Attention::

    コード例では省略していますが、MPI_File_open処理やMPI_File_write_at処理などのエラー対処は必ず行うようにしてください。

ファイルを追記モード(MPI_MODE_APPEND)でopenした場合の例も記載します。

[追記モードでオープンした１ファイルに対して複数プロセスから 1 MB ずつデータを書込むコード例]

  .. code-block:: c
    :linenos:

    MPI_File fh;
    MPI_File_open(MPI_COMM_WORLD, "output.txt", MPI_MODE_APPEND | MPI_MODE_WRONLY, MPI_INFO_NULL, &fh);
    MPI_File_write(fh, data, 1000000, MPI_CHAR, MPI_STATUS_IGNORE);
    MPI_File_close(&fh);

  .. Attention::

    コード例では省略していますが、MPI_File_open処理やMPI_File_write処理などのエラー対処は必ず行うようにしてください。

.. _WriteMultiProcSys:

MPI-IOを使用しないファイル書込み方法
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

MPI-IOを使用しないファイル書込み方法については、FEFS/LLIOで処理の実装方法が異なります。

.. _WriteMultiProcSysFEFS:

・FEFS

  FEFSでは、ファイルシステムの一貫性を保つため、lockを取得せずに、書き込み処理(write処理)を実行します。

  [新規で作成した１ファイルに対して複数プロセスから 1 MB ずつデータを書込むコード例]

    .. code-block:: c
      :linenos:

       int fd;
       fd = open("output.txt", O_WRONLY | O_CREAT, 0644);
       lseek(fd, RANK*1000000, SEEK_SET);
       write(fd, data, 1000000);
       close(fd);

  .. Attention::

    コード例では省略していますが、open処理やwrite処理などのエラー対処は必ず行うようにしてください。

  ファイルを追記モード(O_APPEND)でopenした場合の例も記載します。

  [追記モードの１ファイルに対して複数プロセスから 1 MB ずつデータを書込むコード例]

    .. code-block:: c
      :linenos:

       int fd;
       fd = open("output.txt", O_WRONLY | O_APPEND, 0644);
       write(fd, data, 1000000);
       close(fd);

  .. Attention::

    コード例では省略していますが、open処理やwrite処理などのエラー対処は必ず行うようにしてください。

.. _WriteMultiProcSysLLIO:

・LLIO

  LLIOの場合は、ファイルシステムにて一貫性の制御を行いません。
  そのため、lockを取得してwrite処理を行う、または、Direct I/Oを用いてwrite処理を行います。
  
  LLIOで使用可能はlockは、flock(2)、fcntl(2)です。

  fcntl(2)でlockを取得してwrite処理を行うコード例を以下に記載します。
  
  なお、第2階層ストレージキャッシュ領域で、第2階層ストレージへの書出しタイミングを制御したい場合は、\ :ref:`FefsWriteTiming`\ を参照してください。

  [１ファイルに対して複数プロセスから 1 MB ずつデータを書込むコード例]

    .. code-block:: c
      :linenos:

       int fd;
       fd = open("output.txt", O_WRONLY | O_CREAT, 0644);
       lseek(fd, RANK*1000000, SEEK_SET);
       struct flock lk0 = {.l_type=F_WRLCK, .l_whence=SEEK_SET, .l_start=RANK*1000000, .l_len=1000000};
       fcntl(fd, F_SETLK, &lk0);
       write(fd, data, 1000000);
       struct flock lk1 = {.l_type=F_UNLCK, .l_whence=SEEK_SET, .l_start=RANK*1000000, .l_len=1000000};
       fcntl(fd, F_SETLK, &lk1);
       close(fd);

  .. Attention::

    コード例では省略していますが、open処理やwrite処理などのエラー対処は必ず行うようにしてください。

  ファイルを追記モード(O_APPEND)でopenした場合の例も記載します。

  [追記モードの１ファイルに対して複数プロセスから 1 MB ずつデータを書込むコード例]

    .. code-block:: c
      :linenos:

       int fd;
       fd = open("output.txt", O_WRONLY | O_APPEND, 0644);
       flock(fd, LOCK_EX)
       write(fd, data, 1000000);
       flock(fd, LOCK_UN);
       close(fd);

  .. Attention::

    コード例では省略していますが、open処理やwrite処理などのエラー対処は必ず行うようにしてください。

  Direct I/Oでのwrite処理のコード例を以下に記載します。
  write時のアライメントや書込みサイズについては、計算ノードのページキャッシュのサイズ 64 KiB を考慮する必要があります。
  
  [１ファイルに対して複数プロセスから 1 MB ずつデータを書込むコード例]

    .. code-block:: c
      :linenos:

       int size=1000000*100
       posix_memalign( (void **)&data, 1000000, size);
       int fd;
       fd = open("output.txt", O_DIRECT | O_SYNC | O_WRONLY | O_CREAT, 0644);
       lseek(fd, RANK*1000000, SEEK_SET);
       write(fd, data, 1000000);
       close(fd);

  .. Attention::

    コード例では省略していますが、open処理やwrite処理などのエラー対処は必ず行うようにしてください。

.. _RenameExec:

ファイル名変更
-------------------------------------------

ファイル名を変更する場合は、FEFS/LLIOいずれの場合も、rename処理を実施します。

ただし、第2階層ストレージのキャッシュ領域または共有テンポラリ領域において、計算ノードAでファイルAを別名に変更した後に再作成した場合、計算ノードBでは、ファイルAのopen(2)が失敗することや、計算ノードAでファイルAを別名に変更したファイルがopen(2)されることがあります。

回避するには、以下の対処が必要です

* 計算ノードBでファイルAをopen(2)する前に、ファイルAが存在している親ディレクトリに対してlsコマンドを実行する。

* 計算ノードBでファイルAをopen(2)する前に、計算ノードAのファイルAの再作成後、60秒経過してからopen(2)を行う。

.. _UnlinkExec:

ファイル削除
-------------------------------------------

ファイルを削除する場合は、FEFS/LLIOいずれの場合も、unlink処理を実施します。

ただし、第2階層ストレージのキャッシュ領域または共有テンポラリ領域において、計算ノードAでファイルAを削除した後に再作成した場合、計算ノードBでは、ファイルAのopen(2)が失敗することや、計算ノードAで削除したファイルがopen(2)されることがあります。

回避するには、以下の対処が必要です

* 計算ノードBでファイルAをopen(2)する前に、ファイルAが存在している親ディレクトリに対してlsコマンドを実行する。

* 計算ノードBでファイルAをopen(2)する前に、計算ノードAのファイルAの再作成後、60秒経過してからopen(2)を行う。

