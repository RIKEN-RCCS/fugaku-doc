

<!doctype html>

<html lang="ja" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>8.7. I/Oのプロファイリング &#8212; 利用手引書 利用およびジョブ実行編  ドキュメント</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="../_static/bizstyle.css?v=532c1bf3" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=89e52957" />
    
    <script src="../_static/documentation_options.js?v=c033477b"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/translations.js?v=4dbe4bdc"></script>
    <script src="../_static/bizstyle.js"></script>
    <link rel="search" title="検索" href="../search.html" />
    <link rel="next" title="8.8. I/Oの最適化" href="IOoptimization.html" />
    <link rel="prev" title="8.6. 留意事項" href="LLIOconsiderpoints.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="IOoptimization.html" title="8.8. I/Oの最適化"
             accesskey="N">次へ</a></li>
        <li class="right" >
          <a href="LLIOconsiderpoints.html" title="8.6. 留意事項"
             accesskey="P">前へ</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">利用手引書 利用およびジョブ実行編  ドキュメント</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U"><span class="section-number">8. </span>階層化ストレージ</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">8.7. </span>I/Oのプロファイリング</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="i-o">
<span id="ioprofiling"></span><h1><span class="section-number">8.7. </span>I/Oのプロファイリング<a class="headerlink" href="#i-o" title="Link to this heading">¶</a></h1>
<p>I/Oプロファイリングデータの取得例を示します。</p>
<p>本項と合わせて、取得したプロファイリングデータの活用例 <a class="reference internal" href="IOoptimization.html#iooptimization"><span class="std std-ref">I/Oの最適化</span></a>をご参照ください。</p>
<section id="llio">
<h2><span class="section-number">8.7.1. </span>LLIO性能情報<a class="headerlink" href="#llio" title="Link to this heading">¶</a></h2>
<p>ジョブ投入時に<code class="docutils literal notranslate"><span class="pre">--llio</span> <span class="pre">perf</span></code>オプションを指定すると、LLIO性能情報をジョブの出力結果として得ることができます。これを参照することで、ジョブに関する第1階層ストレージへのアクセス状況を後から分析できます。</p>
<p>LLIO性能情報に関する詳細は、LLIOユーザーズガイドの「2.7.2 LLIO性能情報」を参照ください。</p>
<p>また、次の方法で容易にLLIO領域別のI/O状況を確認することができます。</p>
<ol class="arabic">
<li><p>ジョブ投入時に<code class="docutils literal notranslate"><span class="pre">--llio</span> <span class="pre">perf</span></code>オプションを指定してジョブ実行します。</p></li>
<li><dl class="simple">
<dt>ジョブ終了後、LLIO性能情報が出力されていることを確認します。</dt><dd><p>例) &lt;jobname&gt;.&lt;jobid&gt;.llio_perf</p>
</dd>
</dl>
</li>
<li><p>LLIO性能情報から各領域の状況を確認します。</p>
<p>以下のような集計スクリプトを用意します。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[_LNIlogin]$ </span>cat<span class="w"> </span>sample.awk
<span class="go">/^SIO Infomation/,/END/ {</span>
<span class="go">   sumflg=1</span>
<span class="go">}</span>
<span class="go">/^I\/O     2ndLayerCache   NodeTotal/,/^I\/O     2ndLayerCache   ComputeNode/ {</span>
<span class="go">   if($3 == &quot;Sum&quot; &amp;&amp; sumflg == 1){sum1 += $6}</span>
<span class="go">}</span>
<span class="go">/^I\/O     SharedTmp       NodeTotal/,/^I\/O     SharedTmp       ComputeNode/ {</span>
<span class="go">   if($3 == &quot;Sum&quot; &amp;&amp; sumflg == 1){sum2 += $6}</span>
<span class="go">}</span>
<span class="go">/^I\/O     LocalTmp        NodeTotal/,/^I\/O     LocalTmp        ComputeNode/ {</span>
<span class="go">   if($3 == &quot;Sum&quot; &amp;&amp; sumflg == 1){sum3 += $6}</span>
<span class="go">}</span>
<span class="go">/^Meta    2ndLayerCache   NodeTotal/,/^Meta    SharedTmp       NodeTotal/ {</span>
<span class="go">   if(NF == 3 &amp;&amp; sumflg == 1){sum4 += $3}</span>
<span class="go">}</span>
<span class="go">/^Meta    SharedTmp       NodeTotal/,/^Meta    LocalTmp        NodeTotal/ {</span>
<span class="go">   if(NF == 3 &amp;&amp; sumflg == 1){sum5 += $3}</span>
<span class="go">}</span>
<span class="go">/^Meta    LocalTmp        NodeTotal/,/^Resource        2ndLayerCache   CacheOperation/ {</span>
<span class="go">   if(NF == 3 &amp;&amp; sumflg == 1){sum6 += $3}</span>
<span class="go">}</span>
<span class="go">END {</span>
<span class="go">   total = sum1+sum2+sum3+sum4+sum5+sum6;</span>
<span class="go">   printf(&quot;%-20s %20s %15s\n&quot;, &quot;     Area&quot;,&quot;Time(us)&quot;, &quot;% of Time&quot;);</span>
<span class="go">   printf(&quot;%-20s %20d %15.1f\n&quot;, &quot;Meta 2ndLayerCache&quot;, sum4, (sum4/total)*100);</span>
<span class="go">   printf(&quot;%-20s %20d %15.1f\n&quot;, &quot;     SharedTmp&quot;, sum5, (sum5/total)*100);</span>
<span class="go">   printf(&quot;%-20s %20d %15.1f\n&quot;, &quot;     LocalTmp&quot;, sum6,(sum6/total)*100);</span>
<span class="go">   printf(&quot;%-20s %20d %15.1f\n&quot;, &quot;I/O  2ndLayerCache&quot;, sum1,(sum1/total)*100);</span>
<span class="go">   printf(&quot;%-20s %20d %15.1f\n&quot;, &quot;     SharedTmp&quot;, sum2,(sum2/total)*100);</span>
<span class="go">   printf(&quot;%-20s %20d %15.1f\n&quot;, &quot;     LocalTmp&quot;, sum3,(sum3/total)*100);</span>
<span class="go">}</span>
</pre></div>
</div>
<p>引数にLLIO性能情報を指定して実行します。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[_LNIlogin]$ </span>awk<span class="w"> </span>-f<span class="w"> </span>sample.awk<span class="w"> </span>&lt;jobname&gt;.&lt;jobid&gt;.llio_perf
</pre></div>
</div>
</li>
<li><p>出力された内訳を確認します。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>      Area                        Time(us)       % of Time
Meta  2ndLayerCache           670517500351             4.0
      SharedTmp             15490822246315            92.7
      LocalTmp                 32396742469             0.2
I/O   2ndLayerCache           357836957071             2.1
      SharedTmp               108339293976             0.6
      LocalTmp                 50591120306             0.3
</pre></div>
</div>
<p>この例では、共有テンポラリ領域へのメタアクセスが全体の90%以上を占めていると判断できます。</p>
</li>
</ol>
</section>
<section id="darshan">
<h2><span class="section-number">8.7.2. </span>Darshan<a class="headerlink" href="#darshan" title="Link to this heading">¶</a></h2>
<p>Darshanは、スケーラブルなHPC向けのI/O評価ツールです。
Spackによりツールが提供されており、ジョブのI/O解析として利用できます。
Darshanの詳細については、以下の URL を参照してください。</p>
<p><a class="reference external" href="https://www.mcs.anl.gov/research/projects/darshan/">https://www.mcs.anl.gov/research/projects/darshan/</a></p>
<ol class="arabic">
<li><p>プロファイルデータの取得</p>
<p>取得例を示します。SpackからDarshanを読み込み、mpiexecで実行されるプログラムのI/Oプロファイリングデータを取得します。読み込むdarshan-runtimeは、ジョブID情報が残る<code class="docutils literal notranslate"><span class="pre">scheduler=fj</span></code>を推奨します。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[_LNIlogin]$ </span>spack<span class="w"> </span>find<span class="w"> </span>-lv<span class="w">  </span>darshan-runtime
<span class="go">-- linux-rhel8-a64fx / fj@4.10.0 --------------------------------</span>
<span class="go">kkioahn darshan-runtime@3.4.0~apmpi~apmpi_sync~apxc~hdf5+mpi build_system=autotools scheduler=NONE</span>
<span class="go">czlow63 darshan-runtime@3.4.0~apmpi~apmpi_sync~apxc~hdf5+mpi build_system=autotools scheduler=fj</span>
<span class="go">==&gt; 2 installed packages</span>
</pre></div>
</div>
<p>ジョブスクリプトの記載例</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>.<span class="w"> </span>/vol0004/apps/oss/spack/share/spack/setup-env.sh
spack<span class="w"> </span>load<span class="w"> </span>/czlow63

<span class="nb">export</span><span class="w"> </span><span class="nv">DARSHAN_LOG_DIR_PATH</span><span class="o">=</span>/2ndfs/group/your_dir/<span class="w">       </span><span class="c1"># a</span>
<span class="c1"># export DARSHAN_ENABLE_NONMPI=1                         # b</span>

<span class="nb">export</span><span class="w"> </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="sb">`</span>/home/system/tool/sort_libp<span class="sb">`</span><span class="w">     </span><span class="c1"># c</span>
/home/system/tool/sort_libp<span class="w"> </span>-s<span class="w"> </span>-a<span class="w">                        </span><span class="c1">#</span>

mpiexec<span class="w"> </span>-stdout-proc<span class="w"> </span>./%n.output.%j/%/1000r/stdout<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-stderr-proc<span class="w"> </span>./%n.output.%j/%/1000r/stderr<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-x<span class="w"> </span><span class="nv">LD_PRELOAD</span><span class="o">=</span>libdarshan.so<span class="w">   </span>./a.out
</pre></div>
</div>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<ol class="loweralpha">
<li><div class="line-block">
<div class="line">プロファイリングデータの出力先は、2ndfs領域を推奨します。プロファイリングデータはデフォルトで代表1プロセスが書き込みますが、全ての計算ノードからアクセスされます。数千ノード以上で利用しデータ領域に出力した場合、<a class="reference internal" href="LLIOconsiderpoints.html#llioconsiderpoints"><span class="std std-ref">LLIOの制限</span></a>を超過しノードがスローダウンする可能性があります。</div>
</div>
</li>
<li><div class="line-block">
<div class="line">non-MPI の場合、<code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">DARSHAN_ENABLE_NONMPI=1</span></code>を追加してからLD_PRELOADを有効にしてください。</div>
</div>
</li>
<li><div class="line-block">
<div class="line">動的ライブラリの検索負荷を削減する目的で、/lib64の追加やパスの重複排除、2ndfsや第2階層ストレージのキャッシュ領域のパスを後ろへ並び変えを行っています。また、コマンドの内部で<code class="docutils literal notranslate"><span class="pre">llio_transfer</span></code>を実行しDarshanのライブラリを共通ファイルとして転送しています。詳細は<a class="reference internal" href="../JobExecution/EnvironmentSettings.html#sort-libp"><span class="std std-ref">sort_libp</span></a>を参照ください。</div>
</div>
</li>
</ol>
</div>
<ol class="arabic" start="2">
<li><p>データの確認</p>
<p>ジョブ実行後に、環境変数DARSHAN_LOG_DIR_PATHに指定したディレクトリにプロファイリングデータが出力されていることを確認します。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[_LNIlogin]$ </span>ls<span class="w"> </span>-l<span class="w"> </span>/2ndfs/group/your_dir/
<span class="go">-r-------- 1 usr   group   13701394 Nov 18 08:08 usr_a.out_JOBID.darshan</span>
</pre></div>
</div>
<p>ログインノードからプロファイリングデータを展開できることを確認します。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[_LNIlogin]$ </span>spack<span class="w"> </span>find<span class="w"> </span>-lv<span class="w"> </span>darshan-util
<span class="go">-- linux-rhel8-cascadelake / gcc@13.2.0 -------------------------</span>
<span class="go">dnpyrbu darshan-util@3.4.0~apmpi~apxc~bzip2 build_system=autotools</span>
<span class="go">euiezk6 darshan-util@3.4.4~apmpi~apxc~bzip2 build_system=autotools</span>
<span class="go">==&gt; 2 installed packages</span>
<span class="gp">[_LNIlogin]$ </span>spack<span class="w"> </span>load<span class="w"> </span>/euiezk6
<span class="gp">[_LNIlogin]$ </span>darshan-parser<span class="w">  </span>usr_a.out_JOBID.darshan<span class="w"> </span><span class="p">|</span><span class="w"> </span>less
</pre></div>
</div>
<p>出力例</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>...
# description of columns:
#   &lt;module&gt;: module responsible for this I/O record.
#   &lt;rank&gt;: MPI rank.  -1 indicates that the file is shared
#      across all processes and statistics are aggregated.
#   &lt;record id&gt;: hash of the record&#39;s file path
#   &lt;counter name&gt; and &lt;counter value&gt;: statistical counters.
#      A value of -1 indicates that Darshan could not monitor
#      that counter, and its value should be ignored.
#   &lt;file name&gt;: full file path for the record.
...
#&lt;module&gt; &lt;rank&gt;  &lt;record id&gt;    &lt;counter&gt;                  &lt;value&gt;     &lt;file name&gt; ...
POSIX     -1      0123456789123  POSIX_OPENS                    18432    /vol0n0m/data/group/config
POSIX     -1      0123456789123  POSIX_F_FASTEST_RANK_TIME   0.019958    /vol0n0m/data/group/config
POSIX     -1      0123456789123  POSIX_F_SLOWEST_RANK_TIME  52.856744    /vol0n0m/data/group/config
...
POSIX      0      1234567891234  POSIX_OPENS                        1    /vol0n0m/data/group/tmp.00000
...
POSIX      1      1234567891234  POSIX_OPENS                        1    /vol0n0m/data/group/dat.00001
POSIX      1      1234567891234  POSIX_F_READ_TIME          32.124292    /vol0n0m/data/group/dat.00001
</pre></div>
</div>
</li>
</ol>
<div class="admonition attention">
<p class="admonition-title">注意</p>
<ul class="simple">
<li><p>LLIOの非同期クローズオプションが有効な場合、ファイルが第2階層ストレージに未書き出しの場合でもcloseが即時に復帰する可能性があるため、正確なI/O時間を確認できない場合があります。</p></li>
</ul>
</div>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">目次</a></h3>
    <ul>
<li><a class="reference internal" href="#">8.7. I/Oのプロファイリング</a><ul>
<li><a class="reference internal" href="#llio">8.7.1. LLIO性能情報</a></li>
<li><a class="reference internal" href="#darshan">8.7.2. Darshan</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>前のトピックへ</h4>
    <p class="topless"><a href="LLIOconsiderpoints.html"
                          title="前の章へ"><span class="section-number">8.6. </span>留意事項</a></p>
  </div>
  <div>
    <h4>次のトピックへ</h4>
    <p class="topless"><a href="IOoptimization.html"
                          title="次の章へ"><span class="section-number">8.8. </span>I/Oの最適化</a></p>
  </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="検索" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="IOoptimization.html" title="8.8. I/Oの最適化"
             >次へ</a></li>
        <li class="right" >
          <a href="LLIOconsiderpoints.html" title="8.6. 留意事項"
             >前へ</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">利用手引書 利用およびジョブ実行編  ドキュメント</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" ><span class="section-number">8. </span>階層化ストレージ</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">8.7. </span>I/Oのプロファイリング</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2025, 理化学研究所計算科学研究センター.
    &nbsp;&nbsp;<a href="https://www.fugaku.r-ccs.riken.jp/">Fugaku website Top</a>
    </div>
  </body>
</html>